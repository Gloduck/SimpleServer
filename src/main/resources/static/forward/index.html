<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转发下载工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#249ffd',
                        secondary: '#0d47a1',
                        neutral: '#f0f4f8',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }

            .gradient-bg {
                background: linear-gradient(135deg, #249ffd 0%, #0d6efd 100%);
            }

            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen">
<!-- 顶部导航 -->
<header class="gradient-bg text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fas fa-download text-2xl"></i>
            <h1 class="text-xl md:text-2xl font-bold">转发下载工具</h1>
        </div>
    </div>
</header>

<!-- 主要内容 -->
<main class="container mx-auto px-4 py-8 md:py-16">
    <div class="max-w-3xl mx-auto">
        <!-- 介绍卡片 -->
        <div class="bg-white rounded-xl shadow-soft p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">通过转发下载文件</h2>
            <p class="text-gray-600 mb-4">
                输入您想要下载的文件链接，系统将通过转发服务器为您下载该文件。支持各种类型的文件，包括文档、图片、视频等。</p>

            <!-- 输入区域 -->
            <div class="relative mt-6">
                <div class="flex">
                    <input
                            type="url"
                            id="fileUrl"
                            placeholder="请输入文件下载链接..."
                            class="flex-1 px-4 py-3 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-custom"
                    >
                    <button
                            id="downloadBtn"
                            class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-r-lg font-medium transition-custom flex items-center"
                    >
                        <i class="fas fa-download mr-2"></i>开始下载
                    </button>
                </div>
                <p id="urlError" class="text-red-500 text-sm mt-2 hidden">请输入有效的URL地址</p>
            </div>
        </div>

        <!-- 下载状态卡片 -->
        <div id="downloadStatus" class="bg-white rounded-xl shadow-soft p-6 mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-circle-notch fa-spin mr-2 text-primary"></i>
                <span id="statusText">准备下载...</span>
            </h2>

            <!-- 文件名 -->
            <div class="mb-4">
                <p class="text-sm text-gray-500">文件名</p>
                <p id="fileName" class="text-gray-800 font-medium break-all">-</p>
            </div>

            <!-- 进度条 -->
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-600">下载进度</span>
                    <span id="progressPercent" class="text-primary font-medium">0%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-primary rounded-full w-0 transition-all duration-300"></div>
                </div>
            </div>

            <!-- 下载信息 -->
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-500">已下载</p>
                    <p id="downloadedSize" class="text-gray-800 font-medium">0 KB</p>
                </div>
                <div>
                    <p class="text-gray-500">速度</p>
                    <p id="downloadSpeed" class="text-gray-800 font-medium">-</p>
                </div>
            </div>

            <!-- 取消按钮 -->
            <div class="mt-6">
                <button id="cancelBtn"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition-custom">
                    <i class="fas fa-times mr-2"></i>取消下载
                </button>
            </div>
        </div>

        <!-- 下载历史 -->
        <div class="bg-white rounded-xl shadow-soft p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-history mr-2 text-primary"></i>下载历史
            </h2>

            <div id="downloadHistory" class="space-y-3">
                <div class="text-center text-gray-500 py-8 border border-dashed border-gray-200 rounded-lg">
                    <i class="fas fa-file-download text-3xl mb-2 text-gray-300"></i>
                    <p>暂无下载历史</p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>

    // DOM元素
    const fileUrlInput = document.getElementById('fileUrl');
    const downloadBtn = document.getElementById('downloadBtn');
    const urlError = document.getElementById('urlError');
    const downloadStatus = document.getElementById('downloadStatus');
    const statusText = document.getElementById('statusText');
    const fileNameElement = document.getElementById('fileName');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const downloadedSize = document.getElementById('downloadedSize');
    const downloadSpeed = document.getElementById('downloadSpeed');
    const cancelBtn = document.getElementById('cancelBtn');
    const downloadHistory = document.getElementById('downloadHistory');

    // 变量
    let abortController = null;
    let downloadStartTime = 0;
    let lastDownloadedBytes = 0;
    let speedInterval = null;

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 从URL解析文件名
    function getFileNameFromUrl(url) {
        try {
            const urlObj = new URL(url);
            const pathname = urlObj.pathname;
            const fileName = pathname.split('/').pop();
            return fileName || 'downloaded_file';
        } catch (e) {
            return 'downloaded_file';
        }
    }

    // 添加到下载历史
    function addToHistory(fileName, status, url) {
        const historyItem = document.createElement('div');
        historyItem.className = 'flex items-center justify-between p-3 border border-gray-100 rounded-lg hover:bg-gray-50 transition-custom';

        const statusClass = status === 'success' ? 'text-green-500' : 'text-red-500';
        const statusIcon = status === 'success' ? 'check-circle' : 'times-circle';

        historyItem.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-file mr-3 text-primary"></i>
                    <div>
                        <p class="font-medium text-gray-800 break-all">${fileName}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${new Date().toLocaleString()}</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="text-xs ${statusClass} mr-3"><i class="fas fa-${statusIcon}"></i> ${status === 'success' ? '完成' : '取消'}</span>
                    <button class="text-gray-400 hover:text-primary transition-custom copy-url" data-url="${url}">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            `;

        // 如果是第一个历史项，先清空"暂无历史"提示
        if (downloadHistory.querySelector('.border-dashed')) {
            downloadHistory.innerHTML = '';
        }

        downloadHistory.prepend(historyItem);

        // 添加复制URL事件
        historyItem.querySelector('.copy-url').addEventListener('click', function () {
            const url = this.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(() => {
                const originalIcon = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check"></i>';
                this.classList.add('text-green-500');
                setTimeout(() => {
                    this.innerHTML = originalIcon;
                    this.classList.remove('text-green-500');
                }, 2000);
            });
        });
    }

    // 验证URL
    function isValidUrl(url) {
        try {
            new URL(url);
            return true;
        } catch (e) {
            return false;
        }
    }

    // 开始下载
    downloadBtn.addEventListener('click', startDownload);
    fileUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            startDownload();
        }
    });

    function startDownload() {
        const fileUrl = fileUrlInput.value.trim();

        // 验证输入
        if (!fileUrl || !isValidUrl(fileUrl)) {
            urlError.classList.remove('hidden');
            fileUrlInput.focus();
            return;
        }

        urlError.classList.add('hidden');

        // 编码目标URL，使用固定的转发服务器地址
        const encodedUrl = encodeURIComponent(fileUrl);
        const proxyUrl = `/forward/proxy?url=${encodedUrl}`;

        // 显示下载状态面板
        downloadStatus.classList.remove('hidden');
        statusText.textContent = '连接中...';
        fileNameElement.textContent = getFileNameFromUrl(fileUrl);
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        downloadedSize.textContent = '0 KB';
        downloadSpeed.textContent = '-';

        // 禁用下载按钮
        downloadBtn.disabled = true;
        downloadBtn.classList.add('opacity-70', 'cursor-not-allowed');

        // 创建AbortController用于取消请求
        abortController = new AbortController();

        // 记录开始时间
        downloadStartTime = Date.now();
        lastDownloadedBytes = 0;

        // 启动速度计算定时器
        speedInterval = setInterval(calculateSpeed, 1000);

        // 发送请求
        fetch(proxyUrl, {
            method: 'GET',
            signal: abortController.signal,
            headers: {
                'Accept': '*/*'
            }
        }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status}`);
            }

            // 从响应头获取文件名
            let fileName = getFileNameFromUrl(fileUrl);
            const contentDisposition = response.headers.get('Content-Disposition');

            if (contentDisposition && contentDisposition.includes('filename=')) {
                // 提取文件名（处理可能的编码）
                const fileNameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (fileNameMatch && fileNameMatch[1]) {
                    fileName = fileNameMatch[1].replace(/['"]/g, '');
                    // 处理URL编码的文件名
                    try {
                        fileName = decodeURIComponent(fileName);
                    } catch (e) {
                        console.log('无法解码文件名:', e);
                    }
                }
            }

            // 更新UI
            fileNameElement.textContent = fileName;
            statusText.textContent = '正在下载...';

            const contentLength = response.headers.get('Content-Length');
            const totalBytes = contentLength ? parseInt(contentLength) : null;

            // 处理响应流
            const reader = response.body.getReader();
            const chunks = [];
            let receivedBytes = 0;

            function readChunk() {
                return reader.read().then(({done, value}) => {
                    if (done) {
                        // 下载完成，创建Blob并下载
                        const blob = new Blob(chunks);
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        // 更新状态
                        statusText.textContent = '下载完成';
                        progressBar.style.width = '100%';
                        progressPercent.textContent = '100%';
                        downloadSpeed.textContent = '-';

                        // 添加到历史记录
                        addToHistory(fileName, 'success', fileUrl);

                        return;
                    }

                    chunks.push(value);
                    receivedBytes += value.length;

                    // 更新进度
                    if (totalBytes) {
                        const percent = Math.round((receivedBytes / totalBytes) * 100);
                        progressBar.style.width = `${percent}%`;
                        progressPercent.textContent = `${percent}%`;
                    }

                    // 更新已下载大小
                    downloadedSize.textContent = formatFileSize(receivedBytes);

                    return readChunk();
                });
            }

            return readChunk();
        }).catch(error => {
            if (error.name !== 'AbortError') {
                console.error('下载错误:', error);
                statusText.textContent = `下载失败: ${error.message}`;
                downloadSpeed.textContent = '-';
            }
        }).finally(() => {
            // 清理
            clearInterval(speedInterval);
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            abortController = null;
        });
    }

    // 计算下载速度
    function calculateSpeed() {
        if (!abortController) return;

        const currentTime = Date.now();
        const elapsedTime = (currentTime - downloadStartTime) / 1000; // 秒

        if (elapsedTime > 0) {
            const currentBytesText = downloadedSize.textContent;
            // 提取数值部分并转换为字节
            const [value, unit] = currentBytesText.split(' ');
            const bytes = parseFloat(value) * {
                'Bytes': 1,
                'KB': 1024,
                'MB': 1024 * 1024,
                'GB': 1024 * 1024 * 1024
            }[unit] || 0;

            const bytesSinceLastCheck = bytes - lastDownloadedBytes;
            lastDownloadedBytes = bytes;

            const speed = bytesSinceLastCheck; // 每秒字节数
            downloadSpeed.textContent = formatFileSize(speed) + '/s';
        }
    }

    // 取消下载
    cancelBtn.addEventListener('click', () => {
        if (abortController) {
            abortController.abort();
            statusText.textContent = '下载已取消';
            downloadSpeed.textContent = '-';

            // 添加到历史记录
            addToHistory(fileNameElement.textContent, 'cancelled', fileUrlInput.value.trim());
        }
    });
</script>
</body>
</html>
